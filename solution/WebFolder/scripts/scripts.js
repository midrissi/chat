"use strict";angular.module("chatApp",["ngRoute","wakanda","luegg.directives","ngWebsocket"]).config(["$routeProvider","$httpProvider",function(a,b){var c={app:["$wakanda",function(a){return a.init("Utils")}]};a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{app:["$wakanda",function(a){return a.init()["catch"](function(){location.href="#/login"})}]}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",resolve:c}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl",resolve:c}).otherwise({redirectTo:"/"}),b.interceptors.push("HttpInterceptor")}]).factory("HttpInterceptor",["$q",function(a){return{request:function(b){return b||a.when(b)},requestError:function(b){return a.reject(b)},response:function(b){return b||a.when(b)},responseError:function(b){return 401===b.status&&(location.href="#/login"),a.reject(b)}}}]),angular.module("chatApp").run(["$templateCache",function(a){a.put("views/login.html",'<div class="col-md-6 col-md-offset-3"><p class=login-box-msg>Login</p><div><div class="alert alert-{{msg.type}}" ng-repeat="msg in messages" role=alert ng-bind-html=sce.trustAsHtml(msg.html)></div></div><form ng-submit="login(user, password)"><div class="form-group has-feedback" ng-class="{\'has-error\': hasError}"><input ng-model=user class=form-control ng-disabled=disabled placeholder="Username"> <span class="glyphicon glyphicon-envelope form-control-feedback"></span></div><div class="form-group has-feedback" ng-class="{\'has-error\': hasError}"><input type=password ng-model=password class=form-control ng-disabled=disabled placeholder="Password"> <span class="glyphicon glyphicon-lock form-control-feedback"></span></div><div class=row><div class=col-xs-12><button type=submit class="btn btn-primary btn-block btn-flat" ng-disabled=disabled>Login</button></div></div></form><a href=#/signup>Signup</a></div>'),a.put("views/main.html",'<div class="col-md-8 conversation"><div class="panel panel-info"><div class=panel-heading>{{people.selected? people.selected.fullname: \'Chat Panel\'}}</div><div class=panel-body scroll-glue><ul class=media-list ng-if="messages.length > 0"><li class=media ng-repeat="msg in messages" ng-class="{me: isMe(msg.sender)}"><div class=media-body><div class=media><a class="pull-{{isMe(msg.sender)?\'right\':\'left\'}}" href=""><img class="media-object img-circle" ng-src="{{getAvatar(msg.sender)}}"></a><div class=media-body><p ng-repeat="t in msg.text">{{t.text}}</p><small class=text-muted>{{msg.sender.fullname}} | {{msg.text[msg.text.length - 1].date|date:\'medium\'}}</small><hr></div></div></div></li></ul><p style="text-align: center;margin-top: 50%" ng-if=!conversation>Choose a user to start chatting.</p><p style="text-align: center;margin-top: 50%" ng-if="conversation && messages.length == 0">Type a message to start chatting.</p></div><div class=panel-footer><form class=input-group ng-submit=send(newMsg) style="visibility:{{people.selected? \'initial\': \'hidden\'}}"><input class=form-control ng-model=newMsg placeholder="Enter Message"> <span class=input-group-btn><button class="btn btn-info" type=submit>SEND</button></span></form></div></div></div><div class="col-md-4 users"><div class="panel panel-primary"><div class=panel-heading>{{current.fullname}} <a href="" ng-click=logout() style="color: white" class=pull-right>Logout</a></div><div class=panel-body><ul class=media-list><li class=media ng-repeat="p in people" ng-click="people.selected = p" ng-class="{selected: p.__KEY === people.selected.__KEY, unread: p.preview.unread}"><div class=media-body><div class=media><a class=pull-left href=""><img class="media-object img-circle" style=max-height:40px ng-src="{{getAvatar(p)}}"></a><div class=media-body><h5>{{p.preview.unread? \'(\' + p.preview.unread + \')\': \'\'}} {{p.fullname}}</h5><small class=text-muted ng-if=p.preview.last_message><strong>{{p.preview.user}}:</strong> {{p.preview.last_message|string_shorten:20}}</small> <small class=text-muted ng-if=!p.preview.last_message>No message</small></div></div></div></li></ul></div></div></div>'),a.put("views/signup.html",'<div class="col-md-6 col-md-offset-3"><p class=login-box-msg>Signup</p><div><div class="alert alert-{{msg.type}}" ng-repeat="msg in messages" role=alert ng-bind-html=sce.trustAsHtml(msg.html)></div></div><form ng-submit=signup(user)><div class="form-group has-feedback"><input ng-model=user.firstname class=form-control ng-disabled=disabled placeholder="Firstname (optional)"> <span class="glyphicon glyphicon-user form-control-feedback"></span></div><div class="form-group has-feedback"><input ng-model=user.lastname class=form-control ng-disabled=disabled placeholder="Latsname (optional)"> <span class="glyphicon glyphicon-bookmark form-control-feedback"></span></div><div class="form-group has-feedback"><label>Avatar</label><div class="row avatars"><div class="col-md-4 avatar" ng-repeat="a in avatars" ng-click="user.avatar = a.value" ng-class="{selected: user.avatar == a.value}"><img class=center-block ng-src="{{img_folder + a.src}}"></div></div></div><div class="form-group has-feedback"><input ng-model=user.username class=form-control ng-disabled=disabled placeholder="Username (required)"> <span class="glyphicon glyphicon-envelope form-control-feedback"></span></div><div class="form-group has-feedback"><input type=password ng-model=user.password class=form-control ng-disabled=disabled placeholder="Password (required)"> <span class="glyphicon glyphicon-lock form-control-feedback"></span></div><div class=row><div class=col-xs-12><button type=submit class="btn btn-primary btn-block btn-flat" ng-disabled=disabled>Signup</button></div></div></form><p>Already have an account? <a href=#/login>Signin</a></p></div>')}]),angular.module("chatApp").controller("MainCtrl",["$scope","Global","$sce","$wakanda",function(a,b,c,d){function e(b,c){var d=/\/rest\/Person\(([0-9A-F]*)\)/;if(b.sender&&b.sender.$_deferred&&b.sender.$_deferred.uri&&d.test(b.sender.$_deferred.uri)){var e=/\/rest\/Person\(([0-9A-F]*)\)/.exec(b.sender.$_deferred.uri)[1];if(c.length&&c[c.length-1].sender.__KEY===e)return void c[c.length-1].text.push({text:b.text,date:b.date,__KEY:b.__KEY});var f=a.participants=a.participants||{};f.hasOwnProperty(e)||(f[a.conversation.p1.__KEY]=a.conversation.p1,f[a.conversation.p2.__KEY]=a.conversation.p2),f.hasOwnProperty(e)&&c.push({text:[{text:b.text,date:b.date,__KEY:b.__KEY}],sender:f[e]})}}var f=d.$ds,g={},h=a.current=b.current();h.$promise.then(function(){h.$ws.$on("chat:new",function(b){a.conversation&&b.conversation.__KEY===a.conversation.__KEY?(e({text:b.text,date:b.date,__key:b.__KEY,sender:{$_deferred:{uri:"/rest/Person("+b.sender.__KEY+")"}}},a.messages),angular.extend(a.people.selected.preview,{unread:0,last_message:b.text,date:b.date,user:b.sender.fullname}),a.$apply()):a.refreshPeople()}),h.$ws.$on("person:new",function(){a.refreshPeople()})}),a.people=[],a.sce=c,a.conversation=null,a.messages=[],a.newMsg="",b.avatars.forEach(function(a){g[a.value]=a}),a.refreshPeople=function(){var b=a.people.selected;f.Person.getAll().then(function(c){a.people=c.result,b&&(a.people.selected=b)})["catch"](function(){location.href="#/login"})},a.refreshPeople(),a.getAvatar=function(a){return a&&a.avatar&&g.hasOwnProperty(a.avatar)?b.img_folder+g[a.avatar].src:void 0},a.isMe=function(a){return h.__KEY===a.__KEY},a.logout=function(){d.$logout().then(function(){location.href="/"})},a.send=function(b){if(b){var c;a.conversation.p1.__KEY!==h.__KEY?c=a.conversation.p1.__KEY:a.conversation.p2.__KEY!==h.__KEY&&(c=a.conversation.p2.__KEY),c&&(f.Message.send(b,c)["catch"](function(){location.href="#/login"}),a.newMsg="")}},a.$watch("people.selected",function(b){b&&f.Conversation.getOne(b.__KEY,!0).then(function(c){c&&c.result&&c.result.getKey()&&(a.conversation=f.Conversation.$findOne(c.result.getKey(),{select:"p1, p2"}),a.conversation.$promise.then(function(){a.conversation.setRead().then(function(){angular.extend(b.preview,{unread:0}),a.conversation.messages.$fetch({orderBy:"date desc"}).then(function(b){var c=[];b.forEach(function(a){e(a,c)}),a.messages=c})})}))})["catch"](function(){location.href="#/login"})})}]),angular.module("chatApp").controller("LoginCtrl",["$scope","$wakanda","$sce",function(a,b,c){a.messages=[],a.sce=c,a.disabled=!1,a.hasError=!1,a.login=function(){a.disabled=!0;var c=a.messages=[];b.$login.apply(b,arguments).then(function(b){b&&b.result===!0?location.href="/":(a.hasError=!0,c.push({html:"<strong>Error:</strong> Invalid username or password.",type:"danger"}))})["catch"](function(){a.hasError=!0,c.push({html:"<strong>Error</strong> while authenticating. Please try again.",type:"danger"})})["finally"](function(){a.disabled=!1})}}]),angular.module("chatApp").controller("SignupCtrl",["$scope","$wakanda","$sce","Global",function(a,b,c,d){function e(){a.user={avatar:"young-male"}}var f=b.$ds;a.messages=[],a.sce=c,a.disabled=!1,a.img_folder=d.img_folder,a.avatars=d.avatars,e(),a.signup=function(b){var c=a.messages=[];f.Utils.signup(b).then(function(){c.push({html:'Account created successfully. <a href="#/login">Login</a>',type:"info"}),e()})["catch"](function(){c.push({html:"<strong>Error</strong> while creating the account.",type:"danger"})})}}]),angular.module("chatApp").service("Global",["$wakanda","$websocket","$q","$location",function(a,b,c,d){var e={};return{avatars:[{src:"man1.png",value:"teen-male"},{src:"man2.png",value:"young-male"},{src:"man3.png",value:"old-male"},{src:"woman1.png",value:"teen-female"},{src:"woman2.png",value:"young-female"},{src:"woman3.png",value:"old-female"}],img_folder:"images/",current:function(){return e.$fetching||e.__KEY?e:(e.$fetching=!0,e.$promise=c(function(c){var f=a.$ds;f.Person.getCurrent().then(function(a){angular.extend(e,a.result),e.$fetching=!1;var f=e.$ws=b.$new({url:"ws://"+d.host()+":"+d.port()+"/notifs",protocols:[]});f.$on("$open",function(){f.$emit("init",e.session)}),f.$on("$close",function(){console.log("Websocket closed!")}),c(e)})}),e)}}}]),angular.module("chatApp").filter("debug_print",[function(){return function(a){return console.log("ch.filters.debug.print",a),a}}]).filter("boolean_YesNo",[function(){return function(a){return a===!0?"Yes":"No"}}]).filter("string_format",[function(){return function(a){if(!a||arguments.length<=1)return a;for(var b=1;b<arguments.length;b++){var c=new RegExp("\\{"+(b-1)+"\\}","gm");a=a.replace(c,arguments[b])}return a}}]).filter("string_html2string",[function(){return function(a){return a?$("<div/>").html(a).text():a}}]).filter("string_shorten",[function(){return function(a,b){return!a||!b||a.length<=b?a||"":a.substr(0,b)+(3>=b?"":"...")}}]).filter("string_lowercase",[function(){return function(a){return(a||"").toLowerCase()}}]).filter("string_uppercase",[function(){return function(a){return(a||"").toUpperCase()}}]).filter("string_camelcase",[function(){return function(a){return(a||"").toLowerCase().replace(/(\s.|^.)/g,function(a,b){return b?b.toUpperCase():""})}}]).filter("string_trim",[function(){return function(a){return(a||"").replace(/(^\s*|\s*$)/g,function(){return""})}}]).filter("string_trimstart",[function(){return function(a){return(a||"").replace(/(^\s*)/g,function(){return""})}}]).filter("string_trimend",[function(){return function(a){return(a||"").replace(/(\s*$)/g,function(){return""})}}]).filter("string_replace",[function(){return function(a,b,c,d){d="undefined"==typeof d?!0:d;try{return(a||"").replace(new RegExp(b,d?"g":""),function(){return c})}catch(e){return console.error("error in string_replace",e),a||""}}}]).filter("math_max",[function(){return function(a){return a?Math.max.apply(null,a):a}}]).filter("math_min",[function(){return function(a){return a?Math.min.apply(null,a):a}}]).filter("array_join",[function(){return function(a,b){return a?a.join(b||","):a}}]).filter("array_reverse",[function(){return function(a){return a?a.reverse():a}}]);